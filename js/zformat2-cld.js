/* Copyright 2014 lennart.borgman@gmail.com */ (function(){function v(a,b){if(!b)debugger;if(!b||!/^[0-9]+$/.exec(b))throw"Bad id '"+b+"' in ZURLBuilder";this.m=a;this.id=b}v.prototype.j="https://api.zotero.org/";v.prototype.h="?format\x3datom\x26content\x3djson";function F(a){return a.j+(a.m?"groups":"users")+"/"+a.id+"/"}v.prototype.item=function(a){if(!a)debugger;return F(this)+"items/"+a+this.h};function G(a,b){if(!b)debugger;return F(a)+"items/"+b}v.prototype.children=function(a){if(!a)debugger;return F(this)+"items/"+a+"/children"+this.h+"\x26order\x3ddateAdded\x26sort\x3dasc"};
function K(a,b,e,d,q,p){this.n=a;this.a=b;this.d=e;this.g=d;this.e=q;this.k=p;this.status={}}
K.prototype.onload=function(){debugger;console.log("prototype xhr callback ",this.b.status,this.b);if(4!==this.b.readyState){console.log("readyState",this.b.readyState);alert("wrong zreader onload function called");debugger}if(200<=this.b.status&&400>this.b.status){if(this.a)for(this.a.classList.remove("zreader-requested"),this.a.classList.add("zreader-received");this.a.firstChild;)this.a.removeChild(this.a.firstChild);var a=this.b.responseText;this.g&&this.g(a,this.a);this.d&&(a=L(a),this.d(a,this.a));
this.e&&this.e()}else console.log("Couldn't read the requested file,\x3cbr /\x3estatus \x3d "+this.b.status.toString()),this.a&&(this.a.classList.remove("zreader-requested"),this.a.classList.add("zreader-error"),this.a.appendChild(P("div",null,["Couldn't read the requested file",P("br"),"STATUS \x3d "+this.b.status.toString()])))};function Q(a){if(!a.b)a.b=S(a.n,a.a,a.d,a.g,a.e,a.k,a.status);else if(4===a.b.readyState)a.b.onload()}
function S(a,b,e,d,q,p,t){console.log("zRR",a,"statusObj",t);var c=b?b.dataset.c:void 0;t&&(c=t.status);switch(c){case void 0:t&&(t.status="requested");b&&(c=P("div",{"class":"zreader-request-info"},"Fetching information from Zotero... (this might not work on mobiles due to a bug in Chrome)"),t||(b.dataset.c="requested",b.classList.remove("zreader-error"),b.classList.remove("zreader-received"),b.classList.add("zreader-requested")),b.appendChild(c));var h=new XMLHttpRequest;h.onerror=function(a){logIt(h.statusText);
logIt(a)};h.onload=function(){if(200<=h.status&&400>h.status){t&&(t.status="received");if(b)for(t||(b.dataset.c="received",b.classList.remove("zreader-requested"),b.classList.add("zreader-received"));b.firstChild;)b.removeChild(b.firstChild);var a=h.responseText;d&&d(a,b);e&&(a=L(a),e(a,b));q&&q()}else console.log("Couldn't read the requested file,\x3cbr /\x3estatus \x3d "+h.status.toString()),t&&(t.status="failed"),b&&(t||(b.dataset.c="failed",b.classList.remove("zreader-requested"),b.classList.add("zreader-error")),
b.appendChild(P("div",null,["Couldn't read the requested file",P("br"),"status \x3d "+h.status.toString()])),p&&p())};h.ontimeout=function(){logIt("rq.ontimeout "+a)};h.onreadystatechange=function(){4===h.readyState&&200!==h.status&&console.log("Error",h.statusText)};h.open("GET",a,!0);try{h.send()}catch(f){logIt(f)}return h}}
function L(a){theJX=a;E=a=(new DOMParser).parseFromString(a,"text/xml").querySelectorAll("entry");for(var b=[],e=0;e<a.length;e++){var d=a[e],q=d.getElementsByTagNameNS("http://zotero.org/ns/api","key")[0].textContent,p=d.querySelector("published").textContent,d=d.querySelector("content").firstChild.nodeValue,d=JSON.parse(d);d.zoteroItemKey=q;d.zoteroPublished=p;b[e]=d}return J=b}
function P(a,b,e){function d(a){"string"==typeof a?q.appendChild(document.createTextNode(a)):q.appendChild(a)}var q=document.createElement(a);if(e)if(e.length&&"string"!=typeof e)for(a=0;a<e.length;a++)e[a]&&d(e[a]);else d(e);for(var p in b)q.setAttribute(p,b[p]);return q}function V(a,b){var e=new XMLHttpRequest;e.open("get","http://ourcomments.org/cgi-bin/zlibdesc.php?zlib\x3d"+a,!0);e.onerror=function(a){logIt(rq.statusText);logIt(a)};e.onload=function(){b(e)};try{e.send()}catch(d){logIt(d)}}
function W(a){for(var b="http://zotero.org/groups/"+php_zgi,e=void 0;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(P("span",null,"Fetching info..."));a.style.display="block";V(b,function(d){for(;a.firstChild;)a.removeChild(a.firstChild);if(200<=d.status&&400>d.status){d=d.responseText;var q=P("div");d=d.replace(/ src="[^h]/g,' xsrc\x3d"');q.innerHTML=d;d=q.querySelector("div.minor-col.last-col");for(var p=d.querySelector("ul.group-information"),t;t=p.nextSibling;)t.parentNode.removeChild(t);
p.parentNode.removeChild(p);p=d.querySelectorAll("a");t=0;for(var c;c=p[t++];){var h=c.getAttribute("href");"/"===h.substr(0,1)&&c.setAttribute("href","https://www.zotero.org"+h)}!e&&(e="(fix-me)",q=q.querySelector("[id\x3d'group-show'] h1"))&&(e=q.innerText,q.parentNode.removeChild(q));q=P("div",{"class":"libinfo-header",title:"Visit Zotero"},["Zotero library ",P("a",{href:b},e)]);a.appendChild(q);a.appendChild(d)}else a.innerHTML="Could not get info. Please right click on link.",console.log("Couldn't read the requested file, status \x3d "+
d.status.toString())})};ZReaderRefCopier={l:function(a){var b="undefined"!=typeof tinymce?tinymce.i.o():document.getElementsByTagName("textarea")[0];if("none"==b.style.display)console.log("insert into tinymce"),tinymce.i.execCommand("mceInsertContent",!1,"some text");else if(console.log("insert into textarea at caret pos"),b.selectionStart||0===b.selectionStart){var e=b.selectionStart,d=b.scrollTop;b.value=b.value.substring(0,e)+a+b.value.substring(b.selectionEnd,b.value.length);b.focus();b.selectionStart=e+a.length;b.selectionEnd=
e+a.length;b.scrollTop=d}else console.log("no browser support, IE?"),alert("Please switch to Visual editing mode first")},showForm:function(a,b){function e(){function d(a,b){var c=a[0],s=document.createDocumentFragment();s.appendChild(f("h3",null,c.title));var g=c.abstractNote;if(g&&(g=g.trim(),0<g.length)){var c=g.split("\n"),e="sixteen columns";500<g.length&&(e+=" newspaper-cols");g=P("div",{"class":e});for(e=0;e<c.length;e++)0<g.childNodes.length&&g.appendChild(P("div",{"class":"br"})),g.appendChild(document.createTextNode(c[e]));
s.appendChild(g);b.appendChild(s)}}function e(c,g){zDom=(new DOMParser).parseFromString(c,"application/xml");for(var d=zDom.getElementsByTagNameNS("http://zotero.org/ns/api","year")[0],s=zDom.getElementsByTagNameNS("http://zotero.org/ns/api","creatorSummary")[0],d=f("div",null,["(",f("a",{"data-href":"#"+("z"+a+"-"+b),"class":"zrefcopier-short-ref"},[s?s.firstChild:"(unknown author)"," ",d?d.firstChild:"20xx"]),")"]);d.firstChild;)g.appendChild(d.firstChild)}function t(c,d){function g(a,b){b(a);for(var c=
a.firstChild;c;){var d=c.nextSibling;g(c,b);c=d}}var s=(new DOMParser).parseFromString(c,"text/html").querySelector("div.csl-entry");f("a",{id:"z"+a+"-"+b,"class":"zreader-anchor"},f("span",{"class":"zreader-hidden-anchor"},"*"));g(s,function(a){if("#text"==a.nodeName){var b=a.nodeValue,c=/(.*?doi:)(\S+)(.*)/.exec(b);if(c){var d=document.createDocumentFragment();d.appendChild(document.createTextNode(c[1]));d.appendChild(P("a",{href:"http://dx.doi.org/"+c[2],xtarget:"_blank"},c[2]));0<c[3].length&&
d.appendChild(document.createTextNode(c[3]));a.parentNode.replaceChild(d,a)}if(c=/(.*?)(https?:\/\/\S+)(.*)/.exec(b))d=document.createDocumentFragment(),d.appendChild(document.createTextNode(c[1])),d.appendChild(P("a",{href:c[2],xtarget:"_blank"},c[2])),0<c[3].length&&d.appendChild(document.createTextNode(c[3])),a.parentNode.replaceChild(d,a)}});var e=f("a",{href:"http://ourcomments.org/cgi-bin/zformat.php?"+["zk\x3d"+k,"zgi\x3d"+B,"f\x3dhttp://ourcomments.org/psych/zfsp.html"].join("\x26")},"in"+
String.fromCharCode(160)+"Zotero"),e=f("span",null,[" (",e,")"]);for(s.appendChild(e);d.firstChild;)d.removeChild(d.firstChild);for(s=document.importNode(s,!0);s.firstChild;)d.appendChild(s.firstChild)}var c=document.getElementById("zrefcopier-bg");if(c)c.style.display="flex";else{var h=function(a,c){console.log("updateOutput",a,c);if(a)if(c)x.push(a);else for(var b=0;b<x.length;b++)x[b]===a&&x.splice(b,1);if(l){for(;y.firstChild;)y.removeChild(y.firstChild);for(b=0;b<x.length;b++)switch(y.appendChild(f("hr")),
x[b]){case "citation":for(y.appendChild(z);z.firstChild;)z.removeChild(z.firstChild);if(!I){if(!k)debugger;I=new K(F(l)+"items/"+k+"?format\x3dbib\x26style\x3dapa",z,null,t)}Q(I);break;case "abstract":for(y.appendChild(A);A.firstChild;)A.removeChild(A.firstChild);if(!C){var s=l.item(k);C=new K(s,A,d)}Q(C);break;case "short":for(y.appendChild(u);u.firstChild;)u.removeChild(u.firstChild);H||(H=new K(G(l,k),u,null,e));Q(H);break;default:console.log("bad value in outputList",x)}y.appendChild(f("hr"))}},
f=P,c=f("div",{id:"zrefcopier-bg"});document.body.appendChild(c);var r=c.style;r.position="fixed";r.top="0";r.left="0";r.width="100%";r.height="100%";r.background="rgba(30, 30, 30, 0.7)";r.zIndex="100";r.cursor="wait";var w=f("a",{id:"zrefcopier-closeform",title:"Close"},String.fromCharCode(10006)),D=f("div",{id:"zrefcopier-header"},[f("span",null,"From here you can copy and paste with formatting to Wordpress, LibreOffice etc. "),f("a",{href:"javascript:alert('more info is coming soon')"},"More info")]),
s,M;b||(s=f("input",{id:"zrefcopier-url",type:"text"}),M=f("label",null,["Enter URL of reference in Zotero",s]));f("div");var y=f("div",{id:"zrefcopier-view",contenteditable:"false"}),T=f("div",{id:"zrefcopier-view-container"},[y]),g=f("div",{id:"zrefcopier-inner-controls"}),N=f("button",{title:"Insert in edited post/page"},"Insert"),O=f("div",{id:"zrefcopier-selectall",xtitle:"Select all text"},"Select all text");T.appendChild(O);var X=f("div",{id:"zrefcopier-outer-controls"},[g,N]),U=f("div",{id:"zrefcopier-copy"},
"Now press Control-C to copy to clipboard"),D=f("div",{id:"zrefcopier-form"},[D,M,X,T,w,U]);M=f("div",{id:"zrefcopier-form-container"},D);c.appendChild(M);r.cursor=null;s&&s.focus();w.addEventListener("click",function(){R()});var B=a,k="TI6C7MH6",k="EZBTRX9P",k=b,l;B&&(l=new v(!0,B));B?(O.style.display="inline-block",N.style.display="none"):(O.style.display="none",N.style.display="inline-block");var x=[],r=f("input",{id:"zrefcopier-lnk-chk",type:"checkbox",checked:"checked"}),w=f("label",{title:""},
[r,"Short referens"]);g.appendChild(w);var u=f("p");r.addEventListener("click",function(){h("short",this.checked)});r=f("input",{id:"zrefcopier-cit-chk",type:"checkbox",checked:"checked"});w=f("label",{title:""},[r,"Referens"]);g.appendChild(w);var z=f("blockquote",{"class":"zrefcopier-referens",id:"z"+a+"-"+b});r.addEventListener("click",function(){h("citation",this.checked)});r=f("input",{id:"zrefcopier-abs-chk",type:"checkbox"});w=f("label",{title:""},[r,"Abstract"]);g.appendChild(w);var A=f("blockquote",
{id:"zrefcopier-abstract"});r.addEventListener("click",function(){h("abstract",this.checked)});h("short",!0);h("citation",!0);r.focus();g=function(){var a=null;return function(){var b=s.value;if(b!=a){a=b;for(delete z.dataset.c;z.firstChild;)z.removeChild(z.firstChild);for(delete A.dataset.c;A.firstChild;)A.removeChild(A.firstChild);for(delete u.dataset.c;u.firstChild;)u.removeChild(u.firstChild);k=k||(!0)[2];B||(B="56508");l=new v(!0,B);h()}}}();s&&(s.addEventListener("change",g),s.addEventListener("keyup",
g));N.addEventListener("click",function(){var a=y.cloneNode(!0).innerHTML;ZReaderRefCopier.l(a);c.style.display="none"});O.addEventListener("click",function(){var a=document.createRange();a.selectNodeContents(y);window.getSelection().removeAllRanges();window.getSelection().addRange(a)});y.addEventListener("focus",function(){var a=document.createRange();a.selectNode(y);window.getSelection().removeAllRanges();window.getSelection().addRange(a)});var R=function(){c.style.display="none"};document.addEventListener("keydown",
function(a){a.stopPropagation();U.style.display="none";27==a.keyCode&&R()});c.addEventListener("click",function(a){a.stopPropagation();R()});D.addEventListener("click",function(a){a.stopPropagation();a.stopImmediatePropagation()});c.addEventListener("focusout",function(a){a.stopPropagation();var b=a.relatedTarget;if(b){a=a.target;var d=!1;for(n=0;!d&&b&&30>n++;)b=b.parentNode,d=b===c;d||a&&a.focus()}})}var C,I,H}var d=document.getElementById("zrefcopier-css");if(!d){if(d=document.createElement("link"),
document.head.appendChild(d),d.setAttribute("id","zrefcopier-css"),d.setAttribute("rel","stylesheet"),d.setAttribute("type","text/css"),d.setAttribute("href","http://dl.dropboxusercontent.com/u/848981/it/z/css/edit.css"),d.onload=function(){K&&P&&e()},K&&P)return}else if(K&&P){e();return}d=document.createElement("script");document.head.appendChild(d);d.setAttribute("id","zrefcopier-js");d.onload=function(){e()};d.src="http://dl.dropboxusercontent.com/u/848981/it/z/js/zreader.js";console.log("waiting for zreader.js ...")}};(function(){function a(){var a;a="";var b=window.getSelection().toString();0<b.length&&(a='"'+b+'"');if(b=document.getElementById("tag-container"))for(var b=b.querySelectorAll(".checked-tag"),c=0;c<b.length;c++)0<a.length&&(a+=" "),a+='"'+b[c].firstChild.nodeValue+'"';var b=document.getElementById("glass2"),c=document.getElementById("glass-cont"),d="javascript:alert('Select text or tags to search')";a&&0<a.length?(d=p.f+"?q\x3d"+encodeURIComponent(a),c.classList.add("glass-searchable")):c.classList.remove("glass-searchable");
b.setAttribute("href",d)}function b(a,b){function d(){for(var a=document.getElementById("output-attachments").querySelectorAll("img"),b=/https?:\/\/[^/]+\//,c=0,g=a.length;c<g;c++){var e=a[c],s=e.parentNode.getAttribute("href"),f=b.exec(s)[0]+"favicon.ico";RegExp(/^Full ?text$/).test(e.parentNode.textContent)?f="https://dl.dropboxusercontent.com/u/848981/it/z/img/fulltext.svg":/nih.gov\//.test(f)?f="http://www.ncbi.nlm.nih.gov/favicon.ico":/dropboxusercontent/.test(f)?f="http://www.zotero.org/favicon.ico":
s.substr(0,q.length)===q&&(f="http://dl.dropboxusercontent.com/u/848981/it/z/favicon.ico");a[c].setAttribute("src",f)}}function e(){return c("img",{width:"16",height:"16"})}var g=/[^?]*/.exec(window.location.href),q=g[0];"complete"==document.readyState?setTimeout(d,1):window.onload=d;for(var r=c("div",{"class":"inner-container"}),p=c("div",{"class":"inner-container"}),w=c("div",{"class":"inner-container"}),B=c("div",{"class":"inner-container"}),k=0;k<a.length;k++){var l=a[k],x;for(x in l);switch(l.itemType){case "attachment":switch(l.linkMode){case "linked_url":var g=
l.url,u=l.title,l="color-other";/facebook.com/i.test(g)?l="color-facebook":/full/i.test(u)?l="color-full":/annot/i.test(u)?l="color-annotation":/diigo/i.test(u)?l="color-annotation":/nih.gov/i.test(g)?(l="color-pubmed",t||(t=g)):/books.google./i.test(g)&&(l="color-book",t||(t=g));p.appendChild(c("a",{"class":"attachment linked-url "+l,href:g,xtarget:"_blank"},[e(),c("span",null,u)]));break;case "imported_url":g=l.url;u=l.title;p.appendChild(c("div",{"class":"attachment linked-url"},[c("i",null,u),
", imported web page, can be accessed from desktop Zotero."]));break;case "imported_file":g=l.url;u=l.title;p.appendChild(c("div",{"class":"imported-file attachment"},[c("i",null,u),", attached file, can be accessed from desktop Zotero."]));break;default:console.log("unhandled linkMode:",l)}break;case "note":g=l.note;l=c("div",{"class":"note attachment"},null);l.innerHTML=g;w.appendChild(l);break;default:console.log("unhandled child:",l)}}if("undefined"!==typeof php_parent_zid){g=php_parent_zid;x=
php_parent_zgrp;var z=q+"?zgi\x3d"+x+"\x26zk\x3d"+g,A=G(f,g),u=g;(function(){var a=c("span",null,u),b=c("a",{href:z,"class":"related-item attachment color-related"},[e(),a]);r.appendChild(b);S(A,null,null,function(b){b=(new DOMParser).parseFromString(b,"text/html").querySelector("title").firstChild.nodeValue;a.replaceChild(document.createTextNode(b),a.firstChild)})})()}if(h&&0<Object.keys(h).length){l=/^https?:\/\/zotero.org\/groups\/([0-9]+)\/items\/(.*)$/;c("div",{"class":"related-container"});
for(var D in h){var C=h["dc:relation"];"string"==typeof C&&(C=[C]);for(var k=0,I=C.length;k<I;k++)g=l.exec(C[k]),x=g[1],g=g[2],z=q+"?zgi\x3d"+x+"\x26zk\x3d"+g,A=G(f,g),u=g,function(){var a=c("span",null,u),b=c("a",{href:z,"class":"related-item attachment color-related"},[e(),a]);B.appendChild(b);S(A,null,null,function(b){b=(new DOMParser).parseFromString(b,"text/html").querySelector("title").firstChild.nodeValue;a.replaceChild(document.createTextNode(b),a.firstChild)})}()}}if(0<r.children.length+
p.children.length+w.children.length+B.children.length&&(0<r.children.length&&(k=c("div",{"class":"outer-container",id:"links-container"}),k.appendChild(c("div",{"class":"etc-label-div"},c("span",{"class":"etc-label"},"Owner parent"))),k.appendChild(r),b.appendChild(k)),0<p.children.length&&(k=c("div",{"class":"outer-container",id:"links-container"}),k.appendChild(c("div",{"class":"etc-label-div"},c("span",{"class":"etc-label"},"Links"))),k.appendChild(p),b.appendChild(k)),0<w.children.length&&(k=
c("div",{"class":"outer-container",id:"notes-container"}),k.appendChild(c("div",{"class":"etc-label-div"},c("span",{"class":"etc-label"},"Notes"))),k.appendChild(w),b.appendChild(k)),0<B.children.length)){var k=c("div",{"class":"outer-container",id:"related-container"}),p=c("summary",null,"note"),H=c("span",{style:"display:none"},"Due to a bug in Zotero relations are not displayed both ways. So the relation you see here may not be seen on related documents below. (Hm, it might be gone now. No, it is not!)");
p.addEventListener("click",function(){H.style.display="none"==H.style.display?"inline-block":"none"});k.appendChild(c("div",{"class":"etc-label-div"},[c("span",{"class":"etc-label"},"Related"),c("details",{id:"zot-rel-problems"},[p,H])]));k.appendChild(B);b.appendChild(k)}}function e(){console.log("getLibFromXml -----------------------------");document.getElementById("libinfolink").addEventListener("click",function(a){a.preventDefault();a.stopPropagation();console.log("clicked");a=document.querySelector("#libinfo");
"block"===a.style.display?a.style.display="none":"none"===a.style.display?a.style.display="block":W(a)})}function d(a,b){if("undefined"===typeof ZReaderRefCopier){var d;if(RegExp(/\.php\?/).exec(location.href)){var e=document.querySelector("base");e?d=e.href:function(){var a=document.querySelector("#zformat-js");d=RegExp(/(.*?\/)js\/[^\/]*$/).exec(a.src)[1]}()}else d=location.protocol+"//"+location.host+location.pathname,d=d.replace(/\/zformat.html.*$/,"/");e=c("script",{id:"ourcomments-edit-js"});
document.head.appendChild(e);e.onload=function(){ZReaderRefCopier.showForm(a,b)};e.src=d+"js/edit.js"}else ZReaderRefCopier.showForm(a,b)}function q(){console.log("requestChildren ----------------------------");var a=document.getElementById("output-attachments");if("undefined"===typeof php_parent_zid){var c=f.children(w);S(c,a,b,e)}else b([],a)}var p=new function(a){if(1<a.length)for(var b=0,c=a.substr(1).split("\x26");b<c.length;b++)a=c[b].split("\x3d"),this[decodeURIComponent(a[0])]=1<a.length?
decodeURIComponent(a[1]):""}(window.location.search);p.f="http://OurComments.org/psych/zfsp.html";var t,c=P,h=null,f,r=php_zgi,w=php_zk,D=p.z;(function(){function b(){if(D){var c=/https?:\/\/www.zotero.org\/groups\/(.*?)\/items\/itemKey\/([^/]*)/.exec(D);w=w||c[2]}f=new v(!0,r);document.getElementById("output").style.display="block";document.getElementById("glass2").addEventListener("touchstart",function(a){a.target.p()});document.body.addEventListener("mouseup",function(){a()});document.getElementById("cite").addEventListener("click",
function(a){a.stopPropagation();a.stopImmediatePropagation();a.preventDefault();d(r,w)});for(var c=document.getElementById("output-details").querySelectorAll(".tag [type\x3dcheckbox]"),e=0,h;h=c[e++];)h.addEventListener("click",function(b){b.stopPropagation();this.checked?(this.parentNode.classList.add("checked-tag"),this.style.display="inline-block"):(this.style.display="none",this.parentNode.classList.remove("checked-tag"));a()});q()}switch(document.readyState){case "loading":document.addEventListener("DOMContentLoaded",
function(){b()});break;case "interactive":case "complete":b();break;default:debugger}})()})();})();